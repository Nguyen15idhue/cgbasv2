<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√†ng ƒë·ª£i ph·ª•c h·ªìi - CGBAS Recovery System</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Master CSS -->
    <link rel="stylesheet" href="/css/master.css">
    
    <style>
        .queue-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .queue-table table {
            margin: 0;
        }

        .queue-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .badge-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: #ffc107;
            color: #000;
        }

        .badge-running {
            background: #17a2b8;
            color: white;
        }

        .badge-checking {
            background: #6f42c1;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-failed {
            background: #dc3545;
            color: white;
        }

        .btn-action {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard" class="sidebar-logo">
                <i class="fas fa-rocket"></i>
                <span>CGBAS System</span>
            </a>
        </div>
        
        <div class="sidebar-menu">
            <div class="menu-section-title">Ch√≠nh</div>
            <a href="/dashboard" class="menu-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/queue" class="menu-item active">
                <i class="fas fa-list-ul"></i>
                <span>H√†ng ƒë·ª£i ph·ª•c h·ªìi</span>
                <span class="badge bg-danger" id="queueBadge">0</span>
            </a>
            
            <div class="menu-section-title">Qu·∫£n l√Ω</div>
            <a href="/stations" class="menu-item">
                <i class="fas fa-satellite-dish"></i>
                <span>Danh s√°ch tr·∫°m</span>
            </a>
            <a href="/devices" class="menu-item">
                <i class="fas fa-microchip"></i>
                <span>Thi·∫øt b·ªã eWelink</span>
            </a>
            
            <div class="menu-section-title">H·ªá th·ªëng</div>
            <a href="/logs" class="menu-item">
                <i class="fas fa-file-alt"></i>
                <span>Nh·∫≠t k√Ω h·ªá th·ªëng</span>
            </a>
            <a href="/settings" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>C√†i ƒë·∫∑t</span>
            </a>
        </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="btn-toggle-sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <div class="topbar-title">H√†ng ƒë·ª£i ph·ª•c h·ªìi</div>
        </div>
        
        <div class="topbar-right">
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role">Qu·∫£n tr·ªã vi√™n</div>
                </div>
            </div>
            <button class="btn-logout">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h1>üìã H√†ng ƒë·ª£i ph·ª•c h·ªìi tr·∫°m</h1>
            <p>Theo d√µi c√°c c√¥ng vi·ªác ph·ª•c h·ªìi tr·∫°m ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω</p>
        </div>

        <div class="card queue-table">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID Tr·∫°m</th>
                                <th>ID Thi·∫øt b·ªã</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>L·∫ßn th·ª≠</th>
                                <th>Th·ªùi gian k·∫ø ti·∫øp</th>
                                <th>ƒê√£ t·∫°o</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="queueTableBody">
                            <tr>
                                <td colspan="7">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Master JS -->
    <script src="/js/master.js"></script>

    <script>
        // Status badge mapping
        const statusBadges = {
            'PENDING': '<span class="badge-status badge-pending">Ch·ªù x·ª≠ l√Ω</span>',
            'RUNNING': '<span class="badge-status badge-running">ƒêang ch·∫°y</span>',
            'CHECKING': '<span class="badge-status badge-checking">Ki·ªÉm tra</span>',
            'SUCCESS': '<span class="badge-status badge-success">Th√†nh c√¥ng</span>',
            'FAILED': '<span class="badge-status badge-failed">Th·∫•t b·∫°i</span>'
        };

        // Load queue data
        async function loadQueueData() {
            try {
                const response = await fetch('/api/queue/jobs');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('Failed to load queue data');
                }

                const data = await response.json();
                const tbody = document.getElementById('queueTableBody');
                
                if (!data.jobs || data.jobs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <h5>Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</h5>
                                    <p>H·ªá th·ªëng hi·ªán kh√¥ng c√≥ tr·∫°m n√†o ƒëang trong h√†ng ƒë·ª£i ph·ª•c h·ªìi</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    document.getElementById('queueBadge').textContent = '0';
                    return;
                }

                tbody.innerHTML = data.jobs.map(job => `
                    <tr>
                        <td><strong>${job.station_id}</strong></td>
                        <td><code>${job.device_id || 'N/A'}</code></td>
                        <td>${statusBadges[job.status] || job.status}</td>
                        <td><span class="badge bg-secondary">${job.retry_index || 0}</span></td>
                        <td>${job.next_run_time ? formatDateTime(job.next_run_time) : 'N/A'}</td>
                        <td>${formatDateTime(job.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-action" onclick="cancelJob('${job.station_id}')">
                                <i class="fas fa-times"></i> H·ªßy
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('queueBadge').textContent = data.jobs.length;
            } catch (error) {
                console.error('Error loading queue data:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu h√†ng ƒë·ª£i');
            }
        }

        // Cancel job
        async function cancelJob(stationId) {
            const confirmed = await confirmAction(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy c√¥ng vi·ªác ph·ª•c h·ªìi cho tr·∫°m ${stationId}?`);
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/queue/jobs/${stationId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to cancel job');

                showSuccess('ƒê√£ h·ªßy c√¥ng vi·ªác th√†nh c√¥ng');
                loadQueueData();
            } catch (error) {
                showError('Kh√¥ng th·ªÉ h·ªßy c√¥ng vi·ªác');
            }
        }

        // Format datetime
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Auto refresh every 10 seconds
        loadQueueData();
        setInterval(loadQueueData, 10000);
    </script>
</body>
</html>
